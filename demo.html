<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="metrics-graphics-2.6.0/dist/metricsgraphics.js" charset="utf-8"></script>
  <link rel="stylesheet" href="metrics-graphics-2.6.0/dist/metricsgraphics.css">
</head>

<body>
	<div id="multiLine"></div>
	<div class="legend"></div>
	<div id="userProduct"></div>
	<div id="userRegion"></div>
</body>

<script>

// var product = "RAWA/SUJI", //hard-coded now; gets updated in dropdown.on()
	// testRegion = [];

var dropdown = d3.select("#userProduct")
  .append("select");

var checkboxes = d3.select("#userRegion");



d3.json('example-data/alldata.json', function(data) {

  var product = "RAWA/SUJI",
  	regions = Object.keys(data[product]),
  	productNames = Object.keys(data),
  	newRegions = [];

// Dropdown: Products
    dropdown
      .on("change", function(d) {
        product = d3.select(this).property("value");
        draw();
      });

    dropdown.selectAll("option")
      .data(productNames)
      .enter()
        .append("option")
        .attr("value", function (d) { return d; })
        .text(function (d) { return d; });

// Checkboxes: Regions

	checkboxes.selectAll("input")
		.data(regions)
		.enter()
		.append("label")
			.text(function(d) { return d; })
		.append("input")
			.attr("type", "checkbox")
			.attr("class", "off")
			.attr("value", function(d) { return d; });


	checkboxes.selectAll("input")
			.on("click", function(d) {

				var region = d3.select(this).property("value"),
					index = newRegions.indexOf(region);
					
				if (d3.select(this).attr("class")=="on") {
					d3.select(this).attr("class", "off");
					newRegions.splice(index, 1);
				} else if (d3.select(this).attr("class")=="off") {
					d3.select(this).attr("class", "on");
					newRegions.push(region);
				}


				if (newRegions.length <= 0) {
					console.log("Don't update -regions-.");
					regions = Object.keys(data[product]);
				} else if (newRegions.length > 0) {
					regions = newRegions;
				}

				draw();

			});



	function draw() {
		
		var chartData = prepForChart(data[product],regions);
		  
		  MG.data_graphic({
		      title: "PERI demo",
		      data: chartData,
		      width: 600,
		      height: 300,
		      right: 40,
		      // missing_is_hidden: true,
		      interpolate:'basic',
		      target: '#multiLine',
		      y_accessor: 'price',
		      x_accessor: 'date',
		      legend: regions,
		      legend_target: '.legend'
		  });
	} //draw()

	function prepForChart(productData,regions) {
	  var array = [];
	  regions.forEach(function(region) { // reshape data structure for MG: convert array of key value pairs into array of arrays
	    array.push(productData[region]);
	  });

	  for (var i = 0; i < array.length; i++) {
	      array[i] = MG.convert.date(array[i], 'date');
	  }
	  return array;
	} //prepForChart()

	window.onload = draw()

}); //d3.json()


</script>

</html>